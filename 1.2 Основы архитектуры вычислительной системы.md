#programming 
# Компьютер фон Неймана
## Структура
![[Pasted image 20250911112148.png]]
> ЦП назывался просто процессором. Не было необходимости в разделении.
## Принципы построения компьютера фон Неймана
1. Принцип *двоичного кодирования*
2. Принцип *программного управления* (операция и операнды. Последовательное исполнение команд)
3. Принцип *хранимой программы* (последовательная адресация. Команды и данные располагаются в едином устройстве памяти. Данные различимы только по порядку и интерпретируются в момент использования.)
## Оперативное запоминающее устройство
-  *ОЗУ предназначено для хранения* программы, выполняющейся в компьютере.
- *Тег* - поле служебной информации
	1.Контроль целостности данных (сверка с контрольным разрядом) ![[Pasted image 20250911113553.png]]
	2. Контроль доступа к командам/данным
	3. Контроль доступа к машинным типам данных (типам данных, имеющим программную реализацию для обработки на данной машине)
- *Машинное слово* - поле программно изменяемой информации (разрядность машины)
![[Pasted image 20250911113242.png]]
#### Производительность
> Время именно чтения, т. к. эта операция встречается много чаще операции записи. 
- *Время доступа* (access time) - время между запросом на чтение слова из оперативной памяти и получением содержимого этого слова.
- *Время цикла* (cycle time) - минимальное время между началом текущего и последующего обращения к памяти.
#### Расслоение памяти
- К независимых банков памяти, где $K = 2^l$ ![[Pasted image 20250911114815.png]]
- Две соседние ячейки находятся в разных банках

| ОЗУ без расслоения   | ОЗУ с расслоением на 4 банка с общим контроллером доступа | ОЗУ с расслоением на 4 банка и независимыми контроллерами доступа каждого банка |
| -------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------- |
| ~2\*t_cycle+t_access | ~3\*t_access                                              | ~t_access                                                                       |

##### Модель с общим контроллером доступа
- повторное обращение к банку за t_cycle
- обращение к любому другому банку за t_access
##### Модель с независимыми контроллерами доступа каждого банка
## Центральный процессор
![[Pasted image 20250911120042.png]]
- *Устройство управления* (control unit) - координация выполнения команд
- *Арифметически-логическое устройство* (arithmetic/logic unit) - выполнение команд, арифметической или логической обработки операндов
- *Регистровая память* (register memory) - совокупность устройств памяти процессора - регистров 
- *Кэш-память* (cache memory) - буферизация работы процессора с оперативной памятью
### Регистровая память (регистровый файл)
- Регистры *общего назначения*
	- Программно изменяемые и программно доступные (сглаживают разность скорости процессора и ОЗУ)
	- Бывают скалярные (содержит единицу)/не скалярные (векторные) (например, память cray)
- *Специальные регистры*
	- Счётчик команд
	- указатель стека
	- слово состояние процессора
	- ...
### Рабочий цикл процессора
![[Pasted image 20250918091425.png]]
1. Выбор команды счётчика команд и размещение её в специальном регистре, увеличение счётчика команд на единицу
2. Анализ кода операции
3. Вычисление адресов операндов и получение значений
4. Выполнение команды в АЛУ
> Также есть *третья ветка:* процессор не может выполнить операцию -> ошибка (например несуществующая команда или режим процессора, в котором запрещено исполнение некоторых команд, деление на ноль)
## Кэш-память первого уровня
> Находится внутри процессора.
> [[Расслоениее оперативной памяти|Кэш]] работает в темпе процессора.
![[Pasted image 20250918092725.png]]
- [[Расслоениее оперативной памяти|Буфер памяти]], разделённый на блоки фиксированного размера.
- В полях тегов хранится *информация для организации работы* кэша (свободен/занят блок, адрес области из оперативной памяти)
- Нахождение данных в кэше - *попадание*. Отсутствие искомых данных в кэше - *промах*. 
- В случае попадания, обращения к медленной оперативной памяти не происходит.
- В случае промаха: (вытеснение)
	- *Найти блок кэша*, на место которого можно записать. (случайно/по частоте использования/по времени жизни)
	- Данные из этой ячейки удаляются *(сквозное кэширование)*/устанавливается признак изменённости информации в кэш *(кэширование с обратной связью)*
	- Если в теге фиксировано изменение, информация возвращается в оперативную память. Иначе - как в сквозном.
- При работе с оперативной памятью, *чтение и запись происходят параллельно.*
##### Что даёт кэш?
- сокращение обращений к оперативной памяти
- если обращения происходят, они происходят параллельно -> быстрее
- если кэша 1-го уровня два, можно избежать конфликта потока команд и данных при обмене с оперативной памятью


# Аппарат прерываний
> **Прерывание** - событие в компьютере, при возникновении которого в процессоре происходит предопределённая последовательность действий (заложенная при проектировании процессора).
## Типы прерываний
- *Внутренние* - инициируются схемами контроля процессора
	- Попытка выполнения запрещённой команды
	- Попытка обращения к несуществующей области памяти
	- При обращении к оперативной памяти была выявлена ошибка сохранённой информации
- *Внешние* - события, возникающие в компьютере в результате взаимодействия процессора с внешними устройствами
	- Прерывание по таймеру
	- Завершение чтения с диска
	- Сообщение об ошибке от драйвера диска
## Учебная схема этапов обработки прерываний
1. *Прерывание*
2. *Завершение текущей команды* (команды в процессоре атомарны)
3. Перевод процессора в *режим блокировки прерываний* и сохранение актуального состояния процессора:
	- сохранение набора *специальных регистров* для последующего возобновления работы с точки останова
	- сохранение *части регистров общего назначения* в набор буферных регистров процессора
4. *Программный этап обработки прерывания* (переход на адрес программы обработки прерывания).
### Обработка прерывания
![[Pasted image 20250918100727.png]]
- *Обработка прерывания неуспешна* - система "падает"
- В случае прерывания в состоянии *блокировки прерываний,* прерывания могут *аккумулироваться или игнорироваться*. (зависит от типа прерывания и аппаратной платформы)
# Внешние устройства
## Внешние запоминающие устройства (ВЗУ)
#### Обмен данными:
- записями фиксированного размера - *блоками*
- записями произвольного размера
#### Доступ к данным:
- операции чтения и записи (жёсткий диск, CD-RW)
- только операции чтения (CD-ROM, DVD-ROM) 
##### Последовательного доступа:
- магнитная лента
##### Прямого доступа:
- магнитные диски
- магнитный барабан
- магнитно-электронные ВЗУ прямого доступа
## Устройство прямого доступа
#### Магнитные диски
![[Pasted image 20250918105908.png]]
##### Операции, необходимые для начала чтения (позиционирования):
1. Установка головки на требуемую дорожку (штанга двигает по дискретным позициям)
2. Поворот для смещения головки с началом сектора
> механическая составляющая делает такие устройства медленными и подверженными износу

## Модели синхронизации при обмене с внешними  устройствами
#### Синхронная организация обмена
![[Pasted image 20250918111510.png]]
- ожидание выполнения заказа. неэффективно, медленно
#### Асинхронная организация обмена
![[Pasted image 20250918111551.png]]
- подал заказ на обмен и занимаешься своими делами до момента прерывания
## Иерархия устройств хранения информации
![[Pasted image 20250918111833.png]]
> по:
- Увеличению ёмкости (дороговизна "железа")
- Увеличение времени доступа
- Уменьшение скорости чтения/записи
- Увеличение времени хранения информации
# Аппаратная поддержка ОС и систем программирования
> **Мультипрограммный режим** - режим, при котором возможна организация переключения выполнения с одной программы на другую. ![[Pasted image 20250918112543.png]]

## Базовая аппаратная поддержка мультипрограммного режима
1. Аппарат *защиты памяти* - блокирует нежелательные запросы
2. *Специальный режим операционной системы* (привилегированный режим или режим супервизора)
	- Привилегированный режим *позволяет исполнять все возможные команды,* включая команды управления защитой памяти
	- Пользовательский режим *ограничивает использование* некоторых команд (в случае попытки доступа происходит прерывание)
3. Аппарат прерываний (как минимум, *прерывание по таймеру*) - без него можно уйти в бесконечный цикл
# Вытекающие проблемы и страничная организация памяти
## Перемещаемость программы по ОЗУ
![[Pasted image 20250918114828.png]]
- *Соответствие адресов,* используемых в программе, области ОЗУ, в которой будет размещена данная программа. (нет виртуализации, как сейчас)
## Фрагментация памяти
![[Pasted image 20250918115137.png]]
- Невозможность записать программу в промежутки между уже загруженными. (промежутки меньше, чем загружаемая программа целиком)
## Виртуальная память. Базирование
> Базирование адресов - решение проблемы перемещаемости программы по ОЗУ.
> ![[Pasted image 20250918115523.png]]

> **Аппарат виртуальной памяти** - аппаратные средства компьютера, обеспечивающие преобразование (установленные соответствия) программных адресов, используемых в программе, с адресами физической памяти, в которой размещена (или будет размещена) программа во время выполнения.

> **Базирование адресов** - отображение виртуального адресного пространства в физическую память "один в один". (взаимно однозначно и непрерывно с обеих сторон)

## Виртуальная память. Страничная организация памяти
> **Страницы** - блоки фиксированного размера $2^k$

- Оперативная память *подразделяется* на "блоки" или страницы
- ![[Pasted image 20250925091239.png]]
- *k* зависит от конкретной аппаратной реализации.
- Получаем "глобальный" и "локальный адрес.
- *Количество страниц ограничено* размером поля номеров страницы. 
- Количество физической памяти определяет размер поля номера страницы.
- *Специальный регистр* процессора может быть разрядности большей или меньшей, чем разрядность машины.
- В случае превышения размера страницы программа разбивается на несколько страниц.
- 0-я физическая страница *принадлежит ядру.*
### Преобразование адресного пространства
![[Pasted image 20250925091711.png]]
- *Преобразование* виртуального адреса в физический - *замена номера* виртуальной страницы на соответствующий номер физической страницы. (виртуальная страница размещается в какой-то из физических)
- Операционная система формирует *таблицу страниц,* сопоставляющую физические и виртуальные адреса. (исполняемых в текущий момент программ)
- Количество физических и виртуальных страниц *не обязательно равны.* Например, часть виртуальной памяти использует файл подкачки (swap-file).

### Модельный пример организации
![[Pasted image 20250925093616.png]]
1. Индексация в таблице страниц.
2. $a_{i}$ - физический адрес i-й виртуальной странциы (если $a_{i} = 0$, происходит прерывание и анализ причины ошибки.)
	- Например физический адрес может быть выделен, но программа ещё не загружена -> операционная система ставит программу в *режим ожидания.*
> Так решаются проблемы перемещаемости программы в ОЗУ и фрагментации.

- Минус - страница может использоваться не полностью, но памяти занимает фиксированное количество.
- Невозможность создать в регистрах таблицу, вмещающую в себя все адреса страниц.
## Page fault в страничной организации памяти
> В случае, если процессор обращается к таблице страниц за *адресом, не имеющим отображения* в физическую память, происходит следующее:
#### 1. Прерывание Page fault
> MMU - Memory Management Unit
- Процессор обращается к виртуальному адресу 
- Аппаратный блок управления памятью (MMU) ищет соответствующую *запись в таблице* страниц
- Если бит присутствия (Present bit) для этой страницы сброшен (равен 0), *MMU генерирует исключение* - Page fault
#### 2. Переход в режим ядра
- Управление переходит обработчику прерывания page fault в ядре ОС.
#### 3. Проверка корректности виртуального адреса
- Ядро проверят, является ли обращение легальным
#### 4.A: Ошибка доступа (Access Violation):
- Процесс обратился по адресу, который ему не принадлежит (не выделен или защищён от такого типа доступа)
- **Результат:** ядро отправляет процессу [[2.4 Реализация процессов в ОС UNIX#Сигналы|сигнал]] (например, `SIGSEGV` - segmentation fault). Процесс, как правило, аварийно завершается.
- *Если адрес корректен:*
#### 4.B: Страница в памяти, но защита нарушена  (Soft / Minor Page Fault)
- Процесс пытается писать в страницу, к которой у него нет доступа (например, помеченную "read only")
- **Результат:** Ядро меняет права доступа к странице или создаёт её копию для процесса и продолжает выполнение (быстрый сценарий)
#### 4.C: Страницы нет в оперативной памяти (Hard / Major Page Fault)
- С.1: Страница находится *в swap-области* (на диске)
	- Физической памяти не хватило и ранее страница была "выгружена" в swap-file
	- Ядро находит свободный "кадр" (frame) в оперативной памяти или выбирает страницу для замещения.
	- Ядро отправляет асинхронный запрос драйверу диска, чтобы *прочитать* нужную страницу из swap-файла в выбранный frame
	- Процесс переводится в состояние ожидания (блокировки)
- C.2: Страница является частью исполняемого файла или библиотеки
	- Процесс впервые обратился к коду или данным, которые *ещё не были загружены* в физическую память
	- Ядро инициирует *чтение страницы* из исполняемого файла на диске в оперативную память
#### 5. Загрузка страницы и обновление таблиц
- Дисковый контроллер завершает чтение данных в frame физической памяти
- Драйвер диска отправляет прерывание, сообщающее об успешной записи
#### 6. Пробуждение процесса
- Планировщик ОС помечает процесс как *готовый к выполнению*
- Когда приходит время, процессор возвращается и инструкция, вызвавшая page fault, выполняется заново
#### 7. Успешное выполнение
- MMU находит страницу в оперативной памяти (Presentation bit установлен) и доступ к памяти происходит успешно